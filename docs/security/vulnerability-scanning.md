# Container Vulnerability Scanning

**Last Updated**: January 27, 2025  
**Owner**: DevOps Team  
**Tool**: Trivy by Aqua Security

---

## Overview

Zixly implements automated container vulnerability scanning using Trivy to detect security vulnerabilities in our Docker images before they reach production. This document outlines the scanning process, how to interpret results, and remediation procedures.

## Scanning Strategy

### What We Scan

- **webhook-receiver**: Express.js webhook ingestion service
- **pipeline-worker**: Node.js job processing worker
- **Scope**: OS packages, application dependencies, secrets, misconfigurations

### When We Scan

1. **On Push**: Every commit to `main` or `develop` branches
2. **On Pull Request**: Every PR targeting `main` or `develop`
3. **Scheduled**: Weekly scans every Monday at 9:00 UTC
4. **Manual**: Via workflow_dispatch trigger

### Severity Thresholds

| Severity     | Action        | Description                                            |
| ------------ | ------------- | ------------------------------------------------------ |
| **CRITICAL** | ❌ Fail Build | Exploitable vulnerabilities requiring immediate action |
| **HIGH**     | ❌ Fail Build | Serious vulnerabilities requiring prompt remediation   |
| **MEDIUM**   | ⚠️ Warn       | Monitor and plan remediation                           |
| **LOW**      | ℹ️ Info       | Track but not urgent                                   |

## Viewing Scan Results

### GitHub Security Tab

1. Navigate to **Security** tab in GitHub repository
2. Click **Code scanning alerts**
3. Filter by:
   - `webhook-receiver` category
   - `pipeline-worker` category
4. Click individual alerts for details

### Workflow Logs

1. Go to **Actions** tab
2. Select **Container Security Scanning** workflow
3. View job logs for:
   - SARIF output (uploaded to Security tab)
   - Table output (detailed console view)

### Example Output

```
Total: 5 (CRITICAL: 2, HIGH: 3, MEDIUM: 0, LOW: 0)

┌──────────────────────────┬────────────────┬──────────┬───────────────────┬─────────────────────┐
│        Library           │ Vulnerability  │ Severity │ Installed Version │   Fixed Version     │
├──────────────────────────┼────────────────┼──────────┼───────────────────┼─────────────────────┤
│ express                  │ CVE-2024-12345 │ CRITICAL │ 4.18.2            │ 4.19.0              │
│ node (alpine)            │ CVE-2024-67890 │ HIGH     │ 20.10.0           │ 20.11.1             │
└──────────────────────────┴────────────────┴──────────┴───────────────────┴─────────────────────┘
```

## Remediation Process

### 1. Assess the Vulnerability

**Questions to Answer:**

- Is this a real vulnerability or false positive?
- What is the attack vector?
- Is the vulnerable code path used in our application?
- What is the business impact if exploited?

**Resources:**

- CVE Details: https://cve.mitre.org/
- NVD Database: https://nvd.nist.gov/
- GitHub Advisory Database

### 2. Fix the Vulnerability

#### For Application Dependencies

```bash
# Update package to fixed version
npm update express

# Or specify exact version
npm install express@4.19.0

# Rebuild Docker image
docker build -t webhook-receiver:latest ./services/webhook-receiver

# Verify fix
trivy image webhook-receiver:latest --severity CRITICAL,HIGH
```

#### For Base Image Vulnerabilities

```dockerfile
# Update base image version in Dockerfile
FROM node:20.11.1-alpine3.19

# Rebuild
docker build -t webhook-receiver:latest ./services/webhook-receiver
```

#### For Unfixable Vulnerabilities

If no patch is available:

1. Document the risk assessment
2. Implement compensating controls
3. Consider using a trivy.yaml ignore file (with justification)
4. Plan migration to alternative package

### 3. Test the Fix

```bash
# Run unit tests
npm test

# Build and scan image
docker build -t test-image:latest .
trivy image test-image:latest --severity CRITICAL,HIGH

# Integration testing
docker-compose -f docker-compose.pipeline.yml up -d
# Run smoke tests
```

### 4. Deploy the Fix

```bash
# Commit changes
git add package.json package-lock.json
git commit -m "fix(security): update express to 4.19.0 (CVE-2024-12345)"

# Push to trigger security scan
git push origin feature/security-fix

# Merge PR after scan passes
```

## False Positives

### Creating Exceptions

If Trivy reports a false positive:

1. **Document the Justification**
   - Why is this not exploitable in our context?
   - What analysis was performed?
   - Who approved the exception?

2. **Create trivy.yaml Configuration**

```yaml
# .trivyignore in service root
CVE-2024-12345 # Not exploitable: vulnerable function not used
```

3. **Add Comment to Git**

```bash
git commit -m "chore(security): ignore CVE-2024-12345 - not exploitable

  The vulnerable code path in express is not used by our application.
  We only use express.Router and express.json() middleware.
  Reviewed by: security-team@zixly.com
  Date: 2025-01-27"
```

## Monitoring and Maintenance

### Weekly Review Process

Every Monday after scheduled scan:

1. Review new vulnerabilities in Security tab
2. Triage by severity and exploitability
3. Create GitHub issues for remediation
4. Update security dashboard

### Metrics to Track

- Number of CRITICAL vulnerabilities (target: 0)
- Number of HIGH vulnerabilities (target: < 5)
- Mean time to remediation (target: < 7 days for CRITICAL)
- Scan success rate (target: > 95%)

### Base Image Updates

Update base images monthly:

```bash
# Check for new Node.js releases
docker pull node:20-alpine

# Update Dockerfiles
# FROM node:20.XX.X-alpine3.XX

# Test and deploy
```

## Integration with CI/CD

### Branch Protection Rules

Recommended GitHub branch protection settings:

- [x] Require status checks to pass before merging
- [x] Require branches to be up to date before merging
- [x] Status checks that are required:
  - Container Security Scanning / scan-webhook-receiver
  - Container Security Scanning / scan-pipeline-worker

### Workflow Configuration

The security workflow is defined in `.github/workflows/security.yml`:

```yaml
name: Container Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 9 * * 1' # Weekly on Mondays
```

## Troubleshooting

### Scan Fails Due to Network Issues

```bash
# Retry workflow manually
# GitHub UI: Actions → Container Security Scanning → Re-run jobs

# Or use GitHub CLI
gh workflow run security.yml
```

### Trivy Database Update Failures

Trivy downloads the vulnerability database on each run. If downloads fail:

```bash
# The workflow uses GitHub Actions cache
# Clear cache: Settings → Actions → Caches → Delete specific cache

# Trivy will re-download on next run
```

### Build Timeout (>10 minutes)

If builds are slow:

1. Check Docker build cache is working
2. Verify .dockerignore is properly configured
3. Consider increasing timeout in workflow

## Resources

- **Trivy Documentation**: https://aquasecurity.github.io/trivy/
- **GitHub Security Features**: https://docs.github.com/en/code-security
- **CVE Database**: https://cve.mitre.org/
- **OWASP Top 10**: https://owasp.org/www-project-top-ten/

## Support

**Security Issues**: security@zixly.com  
**DevOps Team**: devops@zixly.com  
**Emergency**: Use GitHub @mention for security-team

---

**Last Review Date**: 2025-01-27  
**Next Review Date**: 2025-02-27  
**Document Owner**: DevOps Team
